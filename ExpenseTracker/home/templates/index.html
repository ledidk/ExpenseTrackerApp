<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Books Manager</title>
    <link rel="stylesheet" href="{% static 'css/books.css' %}">
</head>
<body>
    <!-- Header Section -->
    <header>
        <div class="logo">Books Manager</div>
        <nav>
            <a href="#">Circle Image Here</a>
            <button>Logged in as: Ledidk</button>
        </nav>
    </header>

    <!-- Main Content Section -->
    <div id="main-content">
        <!-- Leftbox (Menu) -->
        <div id="leftbox">
            <div>
                <a href="{% url 'home' %}"><button class="menu-button">
                    <i>üè†</i> Dashboard
                </button></a>
                <a href="{% url 'book_list' %}"><button class="menu-button">
                    <i>üìö</i> Books
                </button></a>
                <a href="{% url 'user_profile' %}"><button class="menu-button">
                    <i>üë§</i> Profile
                </button></a>
            </div>
            <!-- Footer -->
            <div id="leftbox-footer">
                <button>Log out</button>
                <p>Logged in as: Ledidk</p>
            </div>
        </div>

        <!-- Dashboard Page with Middle and Right Boxes -->
        <div id="dashboard-page" class="content active">
            <div class="dashboard-layout">
                <!-- Middlebox -->
                <div id="middlebox">
                    <!-- Middlebox Header -->
                    <div class="box-header books-header">
                        Dashboard Title
                    </div>
                    <!-- Middlebox Content -->
                    <div class="box-content">
                        <select id="timeframeDropdown" class="dropdown">
                            <option value="all">No Timeframe selected</option>
                            <option value="6">Last 6 months</option>
                            <option value="12">Last 12 months</option>
                            <option value="18">Last 18 months</option>
                            <option value="24">Last 24 months</option>
                        </select>

                        <canvas id="myChart" style="width:100%;max-width:600px"></canvas>
                    </div>
                </div>
                <!-- Rightbox -->
                <div id="rightbox">
                    <div class="box-header books-header">
                        Data Title
                    </div>
                    <div id="categoryDetails" class="box-content">
                        Select a category on the chart to view details here.
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    <script>
    console.log("I am didk");
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"> </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const timeframeDropdown = document.getElementById("timeframeDropdown");
            const categoryDetailsDiv = document.getElementById("categoryDetails");
    
            let xCategories = [];
            let yCategoryExpenses = [];
    
            // Function to fetch and update chart data
        // Function to fetch and update chart data
            function fetchChartData(timeframe) {
                console.log("Fetching chart data for timeframe:", timeframe); // Log the selected timeframe

                // Check if the timeframe is "all" and adjust the API endpoint accordingly
                const url = timeframe === "all" ? `/api/books/chart_data` : `/api/books/chart_data?timeframe=${timeframe}`;

                fetch(url)
                    .then(response => {
                        console.log("Response received from /api/books/chart_data:", response); // Log the raw response
                        return response.json();
                    })
                    .then(data => {
                        console.log("Chart data:", data); // Log the entire data object

                        // Update the chart with fetched data
                        xCategories = data.categories;
                        console.log("Categories:", xCategories); // Log categories

                        yCategoryExpenses = data.expenses;
                        console.log("Expenses:", yCategoryExpenses); // Log expenses

                        updateChart(xCategories, yCategoryExpenses);

                        // Display total books and expense in the right div initially (no category selected)
                        categoryDetailsDiv.innerHTML = `
                            <h3>Total Data (All Categories)</h3>
                            <p>Total Books: ${data.total_books}</p>
                            <p>Total Expense: ${data.total_expense}</p>
                        `;
                    })
                    .catch(error => console.error('Error fetching chart data:', error)); // Log any error in fetching
            }

                    
            
    // Function to update the chart
            function updateChart(labels, data) {
                console.log("Updating chart with labels and data:", labels, data); // Log labels and data before updating the chart
    
                const chart = new Chart("myChart", {
                    type: "pie",
                    data: {
                        labels: labels,
                        datasets: [{
                            backgroundColor: [
                                "#b91d47", "#00aba9", "#2b5797", "#e8c3b9", "#1e7145",
                                "#ff5733", "#f4a261", "#6a0dad", "#ffc300", "#581845", "#3498db"
                            ],
                            data: data
                        }]
                    },
                    options: {
                        title: {
                            display: true,
                            text: "Book Expense"
                        },
                        onClick: function (event, elements) {
                            if (elements.length) {
                                const clickedIndex = elements[0]._index;
                                const clickedCategory = labels[clickedIndex];
                                console.log("Clicked category:", clickedCategory); // Log clicked category
                                displayCategoryDetails(clickedCategory);
                            }
                        }
                    }
                });
            }
    
            // Function to display category details when a category is clicked
            function displayCategoryDetails(category) {
                console.log("Fetching details for category:", category); // Log the category being fetched
    
                fetch(`/api/books/category_details?category=${category}`)
                    .then(response => {
                        console.log("Response received from /api/books/category_details:", response); // Log the raw response
                        return response.json();
                    })
                    .then(data => {
                        console.log("Category details data:", data); // Log category details
    
                        categoryDetailsDiv.innerHTML = `
                            <h3>Category: ${category}</h3>
                            <p>Total Books: ${data.total_books}</p>
                            <p>Top 3 Books:</p>
                            <ul>
                                ${data.top_books.map(book => `<li>${book.title}</li>`).join('')}
                            </ul>
                            <p>Total Expense: ${data.total_expense}</p>
                        `;
                    })
                    .catch(error => console.error('Error fetching category details:', error)); // Log any error in fetching
            }
    
            // Fetch initial data when the page loads
            fetchChartData(timeframeDropdown.value);
    
            // Update the chart when the timeframe is changed
            timeframeDropdown.addEventListener("change", function () {
                console.log("Timeframe changed to:", this.value); // Log the new timeframe
                fetchChartData(this.value);
            });
        });
    </script>
    
    
</body>
</html>
